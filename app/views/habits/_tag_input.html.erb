<div class="mt-4">
  <%= form.label :tag_ids, "Tags", class: "nb-label" %>

  <% if current_user.tags.any? %>
    <div class="mt-2 flex flex-wrap gap-2">
      <% current_user.tags.alphabetically.each do |tag| %>
        <label class="inline-flex items-center gap-2 px-3 py-2 min-h-[44px]
                      border-2 border-black cursor-pointer touch-manipulation
                      has-[:checked]:bg-gray-200 has-[:checked]:ring-2 has-[:checked]:ring-black
                      hover:bg-gray-50 transition-colors"
               style="box-shadow: 2px 2px 0 var(--shadow-color, #000)">
          <%= check_box_tag "habit[tag_ids][]", tag.id,
                            habit.tags.include?(tag),
                            class: "sr-only" %>
          <span class="text-sm font-bold"><%= tag.name %></span>
        </label>
      <% end %>
    </div>
  <% end %>

  <div class="mt-3 flex gap-2">
    <%= text_field_tag "new_tag_name", "",
                       id: "new_tag_name",
                       placeholder: "New tag name...",
                       maxlength: 30,
                       class: "nb-input flex-1" %>
    <button type="button"
            onclick="addNewTag(this)"
            class="nb-btn nb-btn--white">
      Add
    </button>
  </div>

  <p class="mt-2 text-xs text-gray-500">Select existing tags or create new ones.</p>
</div>

<script>
function addNewTag(btn) {
  const input = btn.previousElementSibling;
  const name = input.value.trim().toLowerCase();
  if (!name) return;
  if (name.length > 30) return;

  const hidden = document.createElement('input');
  hidden.type = 'hidden';
  hidden.name = 'new_tags[]';
  hidden.value = name;
  btn.closest('form').appendChild(hidden);

  const container = btn.closest('.mt-3').previousElementSibling;
  if (!container || !container.classList.contains('flex-wrap')) {
    const newContainer = document.createElement('div');
    newContainer.className = 'mt-2 flex flex-wrap gap-2';
    btn.closest('.mt-3').before(newContainer);
  }

  const chip = document.createElement('span');
  chip.className = 'inline-flex items-center gap-2 px-3 py-2 min-h-[44px] border-2 border-black bg-gray-200';
  chip.style.boxShadow = '2px 2px 0 var(--shadow-color, #000)';
  chip.innerHTML = `<span class="text-sm font-bold">${name}</span>`;

  const targetContainer = btn.closest('.mt-4').querySelector('.flex-wrap');
  if (targetContainer) {
    targetContainer.appendChild(chip);
  }

  input.value = '';
}
</script>
