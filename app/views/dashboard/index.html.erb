<% content_for :title, "Your Day" %>

<div class="nb-page" data-controller="time-block" data-time-block-date-value="<%= @day.date.to_s %>" data-time-block-hour-height-value="60" data-time-block-start-hour-value="6" data-time-block-end-hour-value="24">
  <div class="nb-page-header">
    <div class="flex-1">
      <p class="text-xs font-black uppercase tracking-widest">Today</p>
      <h1 class="mt-1 text-3xl md:text-5xl font-black leading-tight"><%= @day.date.strftime("%A") %></h1>
      <p class="mt-1 md:mt-2 text-sm text-black/70"><%= @day.date.strftime("%B %d, %Y") %></p>
    </div>

    <!-- Activity visualization - bucket fill style -->
    <div class="flex flex-col items-end gap-2">
      <div class="nb-pill nb-pill--white">
        <span class="inline-block h-2 w-2 border-2 border-black bg-black"></span>
        <span><%= @day.total_hours %>h logged</span>
      </div>

      <!-- Rectangular minimap of the day -->
      <div class="w-32 md:w-48 h-16 md:h-20 border-2 border-black rounded-lg overflow-hidden bg-white flex flex-col-reverse"
           style="box-shadow: 3px 3px 0 #000;">
        <% @day.activity_breakdown.each do |entry| %>
          <% percent = (entry[:hours] / @day.total_day_hours) * 100 %>
          <div class="w-full shrink-0 border-t border-black/20 first:border-t-0"
               style="height: <%= percent %>%; background: <%= entry[:habit].color_css_var %>;"
               title="<%= entry[:habit].name %>: <%= entry[:hours].round(1) %>h">
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Timeline Calendar -->
  <div class="nb-card relative overflow-hidden p-0">
    <!-- Mobile drag hint -->
    <div class="md:hidden flex items-center justify-center border-b-2 border-black bg-white px-3 py-2">
      <span class="text-xs font-bold text-black flex items-center gap-1">
        <span class="inline-block w-3 h-3 rounded bg-black/10 border border-dashed border-black/40"></span>
        Drag ＋ to add time
      </span>
    </div>

    <div class="timeline-container relative" data-time-block-target="timeline">

      <% sections = {
        6 => { name: "Your Morning", bg: "bg-morning" },
        12 => { name: "Your Afternoon", bg: "bg-afternoon" },
        18 => { name: "Your Evening", bg: "bg-evening" }
      } %>

      <!-- All hour rows in one continuous grid -->
      <% (6...24).each do |hour| %>
        <% section = sections[hour] %>
        <% section_bg = sections.select { |h, _| h <= hour }.max_by { |h, _| h }&.last&.dig(:bg) || "bg-white" %>
        
        <% if section %>
          <!-- Section header row -->
          <div class="sticky top-0 z-30 border-b-2 border-black bg-white/95 backdrop-blur px-4 py-2">
            <p class="text-sm font-black uppercase tracking-widest"><%= section[:name] %></p>
          </div>
        <% end %>

        <div class="timeline-hour flex border-b border-black/10 <%= section_bg %> relative" 
             style="height: 60px;"
             data-hour="<%= hour %>">
          <!-- Time label - scrollable area -->
          <div class="w-12 shrink-0 border-r border-black/10 bg-white/50 px-2 py-1">
            <span class="text-xs font-bold text-black/50"><%= format_hour(hour) %></span>
          </div>
          
          <!-- Main content area - scrollable on mobile, draggable on desktop -->
          <div class="flex-1 relative hour-content" data-hour="<%= hour %>"
               data-action="mousedown->time-block#startDrag">
            <!-- Existing time blocks for this hour -->
            <% @day.time_blocks.select { |b| b.start_hour.to_i == hour }.each do |block| %>
              <% block_height = (block.end_hour - block.start_hour) * 60 %>
              <div class="absolute inset-x-1 z-10 rounded-lg border-2 border-black cursor-pointer transition-transform hover:scale-[1.02] habit-card"
                   style="top: 0; height: <%= block_height %>px; background: <%= block.habit.color_css_var %>;"
                   data-token="<%= block.habit.color_token %>"
                   data-time-block
                   data-action="click->time-block#deleteBlock"
                   data-block-id="<%= block.id %>"
                   data-habit-id="<%= block.habit_id %>">
                <div class="p-2 h-full flex flex-col">
                  <p class="font-black text-sm truncate"><%= block.habit.name %></p>
                  <% if block.duration_hours >= 2 %>
                    <p class="text-xs opacity-70 mt-1"><%= block.time_range_display %></p>
                  <% end %>
                  <% if block.notes.present? && block.duration_hours >= 2 %>
                    <p class="text-xs opacity-50 mt-auto truncate"><%= block.notes %></p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Drag handle zone - for mobile touch dragging -->
          <div class="drag-handle w-12 shrink-0 border-l border-dashed border-black/20 flex items-center justify-center cursor-pointer"
               data-hour="<%= hour %>"
               data-action="touchstart->time-block#startTouchDrag mousedown->time-block#startDrag">
            <span class="text-lg font-black text-black/30 select-none">＋</span>
          </div>
        </div>
      <% end %>

      <!-- Drag selection overlay - INSIDE the scrollable container -->
      <div data-time-block-target="selection"
           class="hidden absolute left-12 right-12 md:right-1 border-2 border-dashed rounded-lg z-20 pointer-events-none"
           style="top: 0; height: 60px; background: var(--accent-primary); opacity: 0.5; border-color: var(--accent-primary);">
      </div>
    </div>

    <!-- Instruction overlay when empty -->
    <% if @day.time_blocks.empty? %>
      <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-40">
        <div class="nb-card nb-card--tight bg-white/95 text-center max-w-xs">
          <p class="text-lg font-black hidden md:block">Drag to log time</p>
          <p class="text-lg font-black md:hidden">Drag ＋ to log time</p>
          <p class="text-sm text-black/70 mt-1">Select a time range, then choose a habit</p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Habit Selection Modal -->
  <div data-time-block-target="modal"
       class="hidden fixed inset-0 z-50 items-center justify-center bg-black/50 p-4"
       data-action="click->time-block#closeModal">
    <div class="nb-card w-full max-w-md max-h-[80vh] overflow-y-auto"
         data-action="click->time-block#stopPropagation"
         onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <div>
          <p class="text-xs font-black uppercase tracking-widest">New time block</p>
          <p class="text-2xl font-black mt-1" data-time-display>--</p>
        </div>
        <button type="button" class="nb-btn nb-btn--white" data-action="click->time-block#closeModal">
          ✕
        </button>
      </div>

      <!-- Hidden inputs for form submission -->
      <input type="hidden" data-time-block-target="startHourInput">
      <input type="hidden" data-time-block-target="endHourInput">

      <!-- Existing habits -->
      <% if @day.habits.any? %>
        <p class="text-xs font-black uppercase tracking-widest mb-3">Choose a habit</p>
        <div class="grid gap-2 mb-6">
          <% @day.habits.each do |habit| %>
            <button type="button"
                    class="nb-btn text-left justify-start habit-card"
                    style="background: <%= habit.color_css_var %>;"
                    data-token="<%= habit.color_token %>"
                    data-action="click->time-block#selectHabit"
                    data-habit-id="<%= habit.id %>">
              <span class="inline-block w-3 h-3 border-2 border-black rounded-full mr-2"
                    style="background: <%= habit.color_css_var %>;"></span>
              <%= habit.name %>
            </button>
          <% end %>
        </div>
      <% end %>

      <!-- Quick create new habit -->
      <p class="text-xs font-black uppercase tracking-widest mb-3">Or create new</p>
      <div class="flex gap-2">
        <input type="text"
               class="nb-input flex-1"
               placeholder="New habit name..."
               data-time-block-target="newHabitName"
               data-action="keydown.enter->time-block#createNewHabit">
        <button type="button"
                class="nb-btn nb-btn--yellow"
                data-action="click->time-block#createNewHabit">
          Create
        </button>
      </div>
    </div>
  </div>
</div>
