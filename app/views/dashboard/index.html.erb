<% content_for :title, "Your Day" %>

<div class="nb-page" data-controller="time-block" data-time-block-date-value="<%= @day.date.to_s %>" data-time-block-hour-height-value="60" data-time-block-start-hour-value="6" data-time-block-end-hour-value="24">
  <div class="nb-page-header">
    <div class="flex-1">
      <p class="text-xs font-black uppercase tracking-widest">Today</p>
      <h1 class="mt-1 text-3xl md:text-5xl font-black leading-tight"><%= @day.date.strftime("%A") %></h1>
      <p class="mt-1 md:mt-2 text-sm text-black/70"><%= @day.date.strftime("%B %d, %Y") %></p>
    </div>

    <!-- Activity visualization - bucket fill style -->
    <div class="flex flex-col items-end gap-2">
      <div class="nb-pill nb-pill--white">
        <span class="inline-block h-2 w-2 border-2 border-black bg-black"></span>
        <span><%= @day.total_hours %>h logged</span>
      </div>

      <!-- Rectangular minimap of the day -->
      <div class="w-32 md:w-48 h-16 md:h-20 border-2 border-black rounded-lg overflow-hidden bg-white flex flex-col-reverse"
           style="box-shadow: 3px 3px 0 #000;">
        <% @day.activity_breakdown.each do |entry| %>
          <% percent = (entry[:hours] / @day.total_day_hours) * 100 %>
          <div class="w-full shrink-0 border-t border-black/20 first:border-t-0"
               style="height: <%= percent %>%; background: <%= entry[:habit].color_css_var %>;"
               title="<%= entry[:habit].name %>: <%= entry[:hours].round(1) %>h">
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Timeline Calendar -->
  <%= render "dashboard/timeline", day: @day %>

  <!-- Habit Selection Modal (for creating new time blocks via drag) -->
  <div data-time-block-target="modal"
       class="hidden fixed inset-0 z-50 items-center justify-center bg-black/50 p-4"
       data-action="click->time-block#closeModal">
    <div class="nb-card w-full max-w-md max-h-[80vh] overflow-y-auto"
         onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <div>
          <p class="text-xs font-black uppercase tracking-widest">New time block</p>
          <p class="text-2xl font-black mt-1" data-time-display>--</p>
        </div>
        <button type="button" class="nb-btn nb-btn--white" data-action="click->time-block#closeModal">
          âœ•
        </button>
      </div>

      <!-- Hidden inputs for form submission -->
      <input type="hidden" data-time-block-target="startHourInput">
      <input type="hidden" data-time-block-target="endHourInput">

      <!-- Existing habits -->
      <% if @day.habits.any? %>
        <p class="text-xs font-black uppercase tracking-widest mb-3">Choose a habit</p>
        <div class="grid gap-2 mb-6">
          <% @day.habits.each do |habit| %>
            <button type="button"
                    class="nb-btn text-left justify-start habit-card"
                    style="background: <%= habit.color_css_var %>;"
                    data-token="<%= habit.color_token %>"
                    data-action="click->time-block#selectHabit"
                    data-habit-id="<%= habit.id %>">
              <span class="inline-block w-3 h-3 border-2 border-black rounded-full mr-2"
                    style="background: <%= habit.color_css_var %>;"></span>
              <%= habit.name %>
            </button>
          <% end %>
        </div>
      <% end %>

      <!-- Quick create new habit -->
      <p class="text-xs font-black uppercase tracking-widest mb-3">Or create new</p>
      <div class="flex gap-2">
        <input type="text"
               class="nb-input flex-1"
               placeholder="New habit name..."
               data-time-block-target="newHabitName"
               data-action="keydown.enter->time-block#createNewHabit">
        <button type="button"
                class="nb-btn nb-btn--yellow"
                data-action="click->time-block#createNewHabit">
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Turbo Frame for Edit Modal (loaded via link click on time blocks) -->
  <%= turbo_frame_tag "edit_modal" %>
</div>
