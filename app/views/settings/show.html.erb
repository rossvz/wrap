<% content_for :title, "Settings" %>

<div class="nb-page">
  <div class="nb-page-header">
    <div>
      <p class="text-xs font-black uppercase tracking-widest">Settings</p>
      <h1 class="mt-1 text-5xl font-black leading-tight">Preferences</h1>
      <p class="mt-2 text-sm text-black/70">Customize your Habit Tracker experience.</p>
    </div>
    <%= link_to "Today", dashboard_path, class: "nb-btn nb-btn--white" %>
  </div>

  <div class="nb-card" data-controller="theme">
    <%= form_with(model: current_user, url: settings_path, method: :patch, class: "grid gap-6", data: { action: "submit->theme#save" }) do |form| %>
      <div>
        <h2 class="text-2xl font-black">Appearance</h2>
        <p class="mt-1 text-sm text-black/70">Choose how Habit Tracker looks for you.</p>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <%= form.label :theme, "Color Theme", class: "nb-label" %>
          <%= form.select :theme, 
              User::THEMES.map { |t| [theme_display_name(t), t] },
              {},
              class: "nb-input mt-2",
              data: { theme_target: "select", action: "change->theme#preview" } %>
          <p class="mt-2 text-xs text-black/70">Preview updates instantly. Save to keep your choice.</p>
        </div>

        <!-- Theme Preview -->
        <div>
          <p class="nb-label">Preview</p>
          <div class="mt-2 grid grid-cols-4 gap-2">
            <% (1..8).each do |token| %>
              <div class="h-10 border-2 border-black habit-bg-<%= token %>" 
                   style="box-shadow: 2px 2px 0 #000;"
                   title="Color <%= token %>"></div>
            <% end %>
          </div>
          <p class="mt-2 text-xs text-black/70">These are your habit colors in the current theme.</p>
        </div>
      </div>

      <div class="border-t-2 border-black pt-6 mt-6">
        <h2 class="text-2xl font-black">Notification Times</h2>
        <p class="mt-1 text-sm text-black/70">
          Select when you'd like to receive habit reminders.
          Times are in your timezone: <strong><%= current_user.effective_timezone %></strong>
        </p>

        <% if current_user.push_subscriptions.none? %>
          <p class="mt-4 text-sm text-amber-600">
            Enable push notifications below to receive reminders.
          </p>
        <% else %>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-4">
            <% [[6, "6 AM"], [9, "9 AM"], [12, "12 PM"], [15, "3 PM"], [18, "6 PM"], [21, "9 PM"]].each do |hour, label| %>
              <label class="flex items-center gap-2 p-3 border-2 border-black rounded cursor-pointer hover:bg-yellow-50 transition-colors">
                <%= check_box_tag "user[notification_hours][]", hour,
                    current_user.notification_hours&.include?(hour),
                    id: "notification_hour_#{hour}",
                    class: "w-5 h-5 accent-yellow-400" %>
                <span class="font-medium"><%= label %></span>
              </label>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
        <%= form.submit "Save settings", class: "nb-btn nb-btn--yellow" %>
      </div>
    <% end %>
  </div>

  <div class="nb-card mt-6"
       data-controller="push-notifications"
       data-push-notifications-vapid-public-key-value="<%= ENV['VAPID_PUBLIC_KEY'] %>"
       data-push-notifications-subscribe-url-value="<%= push_subscriptions_path %>"
       data-push-notifications-unsubscribe-url-value="<%= push_subscriptions_path %>"
       data-push-notifications-test-url-value="<%= test_push_subscriptions_path %>">
    <div>
      <h2 class="text-2xl font-black">Notifications</h2>
      <p class="mt-1 text-sm text-black/70" data-push-notifications-target="status">
        Loading notification status...
      </p>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button type="button"
              class="nb-btn nb-btn--yellow"
              data-push-notifications-target="button"
              data-action="click->push-notifications#subscribe">
        Enable notifications
      </button>
      <button type="button"
              class="nb-btn nb-btn--white hidden"
              data-push-notifications-target="testButton"
              data-action="click->push-notifications#test">
        Test notification
      </button>
    </div>

    <p class="mt-4 text-xs text-black/50">
      Note: On iOS, you must first add this app to your home screen for notifications to work.
    </p>
  </div>

</div>
