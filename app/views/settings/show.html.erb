<% content_for :title, "Settings" %>

<div class="nb-page">
  <div class="nb-page-header">
    <div>
      <p class="text-xs font-black uppercase tracking-widest">Settings</p>
      <h1 class="mt-1 text-5xl font-black leading-tight">Preferences</h1>
      <p class="mt-2 text-sm text-black/70">Customize your Habit Tracker experience.</p>
    </div>
    <%= link_to "Today", dashboard_path, class: "nb-btn nb-btn--white" %>
  </div>

  <div class="nb-card" data-controller="theme">
    <%= form_with(model: current_user, url: settings_path, method: :patch, class: "grid gap-6", data: { action: "submit->theme#save" }) do |form| %>
      <div>
        <h2 class="text-2xl font-black">Appearance</h2>
        <p class="mt-1 text-sm text-black/70">Choose how Habit Tracker looks for you.</p>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <%= form.label :theme, "Color Theme", class: "nb-label" %>
          <%= form.select :theme, 
              User::THEMES.map { |t| [theme_display_name(t), t] },
              {},
              class: "nb-input mt-2",
              data: { theme_target: "select", action: "change->theme#preview" } %>
          <p class="mt-2 text-xs text-black/70">Preview updates instantly. Save to keep your choice.</p>
        </div>

        <!-- Theme Preview -->
        <div>
          <p class="nb-label">Preview</p>
          <div class="mt-2 grid grid-cols-4 gap-2">
            <% Habit::COLOR_TOKENS.each do |token| %>
              <div class="h-8 border-2 border-black habit-bg-<%= token %>"
                   style="box-shadow: 2px 2px 0 #000;"
                   title="Color <%= token %>"></div>
            <% end %>
          </div>
          <p class="mt-2 text-xs text-black/70">These are your habit colors in the current theme.</p>
        </div>
      </div>

      <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
        <%= form.submit "Save settings", class: "nb-btn nb-btn--yellow" %>
      </div>
    <% end %>
  </div>

  <div class="nb-card mt-6"
       data-controller="push-notifications"
       data-push-notifications-vapid-public-key-value="<%= ENV['VAPID_PUBLIC_KEY'] %>"
       data-push-notifications-subscribe-url-value="<%= push_subscriptions_path %>"
       data-push-notifications-unsubscribe-url-value="<%= push_subscriptions_path %>"
       data-push-notifications-test-url-value="<%= test_push_subscriptions_path %>">
    <div>
      <h2 class="text-2xl font-black">Notifications</h2>
      <p class="mt-1 text-sm text-black/70" data-push-notifications-target="status">
        Loading notification status...
      </p>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button type="button"
              class="nb-btn nb-btn--yellow"
              data-push-notifications-target="button"
              data-action="click->push-notifications#subscribe">
        Enable notifications
      </button>
      <button type="button"
              class="nb-btn nb-btn--white hidden"
              data-push-notifications-target="testButton"
              data-action="click->push-notifications#test">
        Test notification
      </button>
    </div>

    <p class="mt-4 text-xs text-black/50">
      Note: On iOS, you must first add this app to your home screen for notifications to work.
    </p>

    <%= form_with(model: current_user, url: settings_path, method: :patch, class: "mt-6 pt-6 border-t-2 border-black") do |form| %>
      <h3 class="text-xl font-black">Notification Times</h3>
      <p class="mt-1 text-sm text-black/70">
        Select when you'd like to receive habit reminders.
        Times are in your timezone: <strong><%= current_user.effective_timezone %></strong>
      </p>

      <% if current_user.push_subscriptions.none? %>
        <p class="mt-4 text-sm text-amber-600">
          Enable push notifications above to receive reminders.
        </p>
      <% else %>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-4">
          <% [[6, "6 AM"], [9, "9 AM"], [12, "12 PM"], [15, "3 PM"], [18, "6 PM"], [21, "9 PM"]].each do |hour, label| %>
            <label class="nb-checkbox-label">
              <%= check_box_tag "user[notification_hours][]", hour,
                  current_user.notification_hours&.include?(hour),
                  id: "notification_hour_#{hour}",
                  class: "nb-checkbox" %>
              <span class="font-medium"><%= label %></span>
            </label>
          <% end %>
        </div>

        <div class="mt-4">
          <%= form.submit "Save notification times", class: "nb-btn nb-btn--yellow" %>
        </div>
      <% end %>
    <% end %>
  </div>

  <div class="nb-card mt-6">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-2xl font-black">API Tokens</h2>
        <p class="mt-1 text-sm text-black/70">
          Generate tokens for CLI tools and integrations.
        </p>
      </div>
      <%= link_to "Manage Tokens", api_tokens_path, class: "nb-btn nb-btn--yellow" %>
    </div>
  </div>

  <div class="nb-card mt-6">
    <%= form_with model: current_user, url: settings_path, method: :patch do |form| %>
      <div class="mb-4">
        <h2 class="text-2xl font-black">Work Schedule</h2>
        <p class="mt-1 text-sm text-black/70">
          Configure your typical work hours to see them on the timeline.
        </p>
      </div>

      <div class="mb-4">
        <label class="nb-checkbox-label cursor-pointer">
          <%= form.check_box :work_hours_enabled,
              { checked: current_user.work_hours_enabled? },
              "true", "false" %>
          <span class="font-medium">Show work hours on timeline</span>
        </label>
      </div>

      <div class="grid gap-4 sm:grid-cols-2 mb-4">
        <div>
          <%= form.label :work_start_hour, "Start Time", class: "nb-label" %>
          <%= form.select :work_start_hour,
              work_hour_options,
              { selected: current_user.work_start_hour },
              class: "nb-input mt-2 w-full" %>
        </div>
        <div>
          <%= form.label :work_end_hour, "End Time", class: "nb-label" %>
          <%= form.select :work_end_hour,
              work_hour_options,
              { selected: current_user.work_end_hour },
              class: "nb-input mt-2 w-full" %>
        </div>
      </div>

      <div class="mb-6">
        <p class="nb-label mb-2">Work Days</p>
        <%= hidden_field_tag "user[work_days][]", "" %>
        <div class="flex flex-wrap gap-2">
          <% day_toggle_options.each do |name, value| %>
            <label class="cursor-pointer">
              <%= check_box_tag "user[work_days][]", value,
                  current_user.work_days.include?(value),
                  id: "work_day_#{value}",
                  class: "peer sr-only" %>
              <div class="nb-btn nb-btn--white px-3 py-2 text-sm font-bold
                          peer-checked:bg-yellow-400 peer-checked:ring-2 peer-checked:ring-black">
                <%= name %>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <div>
        <%= form.submit "Save work schedule", class: "nb-btn nb-btn--yellow" %>
      </div>
    <% end %>
  </div>

</div>
